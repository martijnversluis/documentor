<div class="max-w-3xl mx-auto">
  <div class="mb-6">
    <div class="flex items-center justify-between mb-2">
      <h1 class="text-2xl font-bold text-gray-900">Power Through</h1>
      <%= link_to action_items_path(today: "1"), class: "text-sm text-gray-500 hover:text-gray-700" do %>
        <span class="inline-flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Sluiten
        </span>
      <% end %>
    </div>
    <p class="text-sm text-gray-500">Werk je actiepunten voor vandaag één voor één af</p>
  </div>

  <%# Progress bar %>
  <div class="mb-8">
    <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
      <span>Item <%= @current_index + 1 %> van <%= @total_count %></span>
      <span><%= @completed_count %> vandaag afgerond</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2">
      <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: <%= (@current_index.to_f / @total_count * 100).round %>%"></div>
    </div>
  </div>

  <%# Current item card %>
  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-6">
    <div class="p-6">
      <%# Item metadata %>
      <div class="flex items-center gap-2 mb-4 flex-wrap">
        <% if @current_item.dossier.present? %>
          <%= link_to @current_item.dossier.name, @current_item.dossier, class: "text-sm text-blue-600 hover:underline" %>
        <% else %>
          <span class="text-sm text-gray-400">Inbox</span>
        <% end %>
        <% if @current_item.context.present? %>
          <span class="text-sm text-teal-600 font-medium">@<%= @current_item.context %></span>
        <% end %>
        <% if @current_item.waiting? %>
          <span class="inline-flex items-center gap-1 text-sm text-orange-600 font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Wacht op <%= @current_item.waiting_for_display %>
          </span>
        <% end %>
        <% if @current_item.estimated_minutes.present? %>
          <span class="inline-flex items-center gap-1 text-sm text-emerald-600 font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <%= ActionItem::DURATION_OPTIONS.find { |label, val| val == @current_item.estimated_minutes }&.first %>
          </span>
        <% end %>
        <% if @current_item.has_children? %>
          <span class="inline-flex items-center gap-1 text-sm text-gray-500">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
            </svg>
            <%= @current_item.children.completed.count %>/<%= @current_item.children.count %> sub-items
          </span>
        <% end %>
      </div>

      <%# Item description %>
      <div class="prose prose-lg max-w-none mb-6">
        <%= markdown(@current_item.description) %>
      </div>

      <%# Notes (if present) %>
      <% if @current_item.notes.present? %>
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <div class="prose prose-sm max-w-none text-amber-900">
              <%= markdown(@current_item.notes) %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Sub-items section %>
      <div class="border-t border-gray-100 pt-4 mb-4" id="sub-items-section">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">
            Sub-items
            <% if @current_item.has_children? %>
              (<%= @current_item.children.completed.count %>/<%= @current_item.children.count %>)
            <% end %>
          </h3>
        </div>

        <%# Form to add new sub-item %>
        <div class="mb-3">
          <%= form_with model: ActionItem.new, url: action_items_path(redirect_to: power_through_action_items_path(item_id: @current_item.id)), class: "flex items-center gap-2", data: { turbo: false } do |f| %>
            <%= f.hidden_field :parent_id, value: @current_item.id %>
            <%= f.hidden_field :dossier_id, value: @current_item.dossier_id %>
            <%= f.hidden_field :due_date, value: @current_item.due_date %>
            <%= f.text_field :description, placeholder: "Nieuw sub-item toevoegen...", class: "flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
            <%= f.submit "Toevoegen", class: "px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 cursor-pointer" %>
          <% end %>
        </div>

        <%# Pending sub-items %>
        <% if @current_item.children.pending.any? %>
          <ul class="space-y-3" id="pending-sub-items">
            <% @current_item.children.pending.ordered.each do |child| %>
              <li class="bg-gray-50 rounded-lg p-3" id="<%= dom_id(child) %>">
                <div class="flex items-start gap-3">
                  <%= button_to toggle_action_item_path(child, redirect_to: power_through_action_items_path(item_id: @current_item.id)), method: :patch, class: "flex-shrink-0 mt-0.5", form: { data: { turbo: false } } do %>
                    <div class="w-5 h-5 rounded border-2 border-gray-300 hover:border-green-500 hover:bg-green-50 flex items-center justify-center cursor-pointer transition-colors">
                    </div>
                  <% end %>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2">
                      <p class="text-sm text-gray-700"><%= child.description %></p>
                      <div class="flex items-center gap-1 flex-shrink-0">
                        <%= link_to edit_action_item_path(child, return_to: power_through_action_items_path(item_id: @current_item.id)), class: "p-1 text-gray-400 hover:text-blue-600 transition-colors", title: "Bewerken" do %>
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                          </svg>
                        <% end %>
                        <%= button_to action_item_path(child), method: :delete, class: "p-1 text-gray-400 hover:text-red-600 transition-colors", title: "Verwijderen", form: { data: { turbo_confirm: "Weet je zeker dat je dit sub-item wilt verwijderen?" } } do %>
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        <% end %>
                      </div>
                    </div>
                    <div class="mt-2" data-controller="power-through-notes" data-power-through-notes-url-value="<%= update_notes_action_item_path(child) %>">
                      <%= text_area_tag "child_notes_#{child.id}", child.notes,
                          rows: 2,
                          placeholder: "Notities voor dit sub-item...",
                          class: "w-full px-3 py-2 text-xs border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent resize-none bg-white",
                          data: { power_through_notes_target: "notes", action: "input->power-through-notes#scheduleAutoSave" } %>
                      <p class="text-xs text-gray-400 mt-1" data-power-through-notes-target="status"></p>
                    </div>
                  </div>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>

        <%# Completed sub-items (collapsed) %>
        <% if @current_item.children.completed.any? %>
          <details class="mt-3">
            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-700">
              <%= @current_item.children.completed.count %> afgeronde sub-items tonen
            </summary>
            <ul class="mt-2 space-y-2">
              <% @current_item.children.completed.order(completed_at: :desc).each do |child| %>
                <li class="flex items-start gap-3 text-sm text-gray-400">
                  <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <div class="flex-1 min-w-0">
                    <p class="line-through"><%= child.description %></p>
                    <% if child.notes.present? %>
                      <p class="text-xs text-gray-400 mt-1 italic"><%= truncate(child.notes, length: 100) %></p>
                    <% end %>
                  </div>
                </li>
              <% end %>
            </ul>
          </details>
        <% end %>

        <% if @current_item.children.empty? %>
          <p class="text-sm text-gray-400 italic">Nog geen sub-items</p>
        <% end %>
      </div>

      <%# Notes field %>
      <div class="border-t border-gray-100 pt-4" data-controller="power-through-notes" data-power-through-notes-url-value="<%= update_notes_action_item_path(@current_item) %>">
        <label class="block text-sm font-medium text-gray-700 mb-2">Notities (optioneel)</label>
        <div class="prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded-lg px-4 py-3 -mx-4 min-h-[60px] border border-transparent hover:border-gray-200 <%= @current_item.notes.blank? ? 'text-gray-400' : 'text-gray-700' %>"
             data-power-through-notes-target="display"
             data-action="click->power-through-notes#edit">
          <% if @current_item.notes.present? %>
            <%= markdown(@current_item.notes) %>
          <% else %>
            <span class="italic">Klik om notities toe te voegen...</span>
          <% end %>
        </div>
        <%= text_area_tag :notes, @current_item.notes,
            placeholder: "Notities... (markdown ondersteund)",
            class: "hidden w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none overflow-hidden",
            data: { controller: "markdown-paste", power_through_notes_target: "notes", action: "input->power-through-notes#input blur->power-through-notes#blur" } %>
        <p class="text-xs text-gray-400 mt-1" data-power-through-notes-target="status"></p>
      </div>
    </div>

    <%# Action buttons %>
    <div class="bg-gray-50 px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <% if @current_index > 0 %>
          <% prev_item = @all_items[@current_index - 1] %>
          <%= link_to power_through_action_items_path(item_id: prev_item.id), class: "inline-flex items-center gap-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Vorige
          <% end %>
        <% end %>
        <% if @current_index < @total_count - 1 %>
          <% next_item = @all_items[@current_index + 1] %>
          <%= link_to power_through_action_items_path(item_id: next_item.id), class: "inline-flex items-center gap-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" do %>
            Volgende
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          <% end %>
        <% end %>
      </div>

      <div class="flex items-center gap-2">
        <%= link_to power_through_action_items_path(item_id: @all_items[(@current_index + 1) % @total_count]&.id), class: "inline-flex items-center gap-1 px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50", data: { turbo_method: :patch, turbo_action: "replace" } do %>
          Overslaan
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
          </svg>
        <% end %>
        <%= button_to toggle_action_item_path(@current_item), method: :patch, class: "inline-flex items-center gap-2 px-6 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2", form: { data: { turbo: false } } do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Afronden
        <% end %>
      </div>
    </div>
  </div>

  <%# All items overview %>
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="px-4 py-3 border-b border-gray-100">
      <h2 class="font-semibold text-gray-700">Alle items voor vandaag</h2>
    </div>
    <ul class="divide-y divide-gray-100">
      <% @all_items.each_with_index do |item, index| %>
        <li class="px-4 py-3 flex items-center gap-3 <%= item == @current_item ? 'bg-blue-50' : '' %>">
          <% if item == @current_item %>
            <div class="w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
              <span class="text-xs text-white font-medium"><%= index + 1 %></span>
            </div>
          <% else %>
            <div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
              <span class="text-xs text-gray-500"><%= index + 1 %></span>
            </div>
          <% end %>
          <%= link_to power_through_action_items_path(item_id: item.id), class: "flex-1 min-w-0 overflow-hidden text-sm #{'font-medium text-blue-700' if item == @current_item} #{'text-gray-600' unless item == @current_item} hover:underline" do %>
            <div class="truncate"><%= strip_tags(markdown(item.description)).squish %></div>
          <% end %>
          <% if item.has_children? && !item.all_children_completed? %>
            <span class="text-xs text-orange-500 flex-shrink-0"><%= item.pending_children_count %> sub</span>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
</div>
