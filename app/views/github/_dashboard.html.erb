<%
  notifications = data[:notifications] || []
  issues = data[:issues] || []
  pull_requests = data[:pull_requests] || []
  username = account&.username

  # Build combined list with types
  items = []

  notifications.each do |n|
    item_id = "notification-#{n[:id]}"
    items << {
      id: item_id,
      type: :notification,
      title: n[:subject][:title],
      repo: n[:repository][:full_name],
      url: GithubService.notification_url(n),
      reason: n[:reason],
      updated_at: Time.parse(n[:updated_at]),
      icon: notification_icon(n[:subject][:type])
    }
  end

  issues.each do |issue|
    item_id = "issue-#{issue[:id]}"
    # Determine reason for issue
    is_author = issue.dig(:user, :login) == username
    is_assignee = issue[:assignees]&.any? { |a| a[:login] == username }
    reason = is_author ? "author" : (is_assignee ? "assign" : nil)

    items << {
      id: item_id,
      type: :issue,
      title: issue[:title],
      repo: issue[:repository_url]&.split("/")&.last(2)&.join("/"),
      url: issue[:html_url],
      number: issue[:number],
      updated_at: Time.parse(issue[:updated_at]),
      labels: issue[:labels],
      reason: reason
    }
  end

  pull_requests.each do |pr|
    item_id = "pr-#{pr[:id]}"
    # Determine reason for PR
    is_author = pr.dig(:user, :login) == username
    is_assignee = pr[:assignees]&.any? { |a| a[:login] == username }
    reason = is_author ? "author" : (is_assignee ? "assign" : nil)

    items << {
      id: item_id,
      type: :pr,
      title: pr[:title],
      repo: pr[:repository_url]&.split("/")&.last(2)&.join("/"),
      url: pr[:html_url],
      number: pr[:number],
      updated_at: Time.parse(pr[:updated_at]),
      draft: pr[:draft],
      reason: reason
    }
  end

  # Sort by updated_at desc
  items.sort_by! { |i| -i[:updated_at].to_i }
%>

<div data-controller="github-items">
  <% if items.empty? %>
    <div class="text-center py-4 text-gray-500 text-sm">
      Geen openstaande items
    </div>
  <% else %>
    <ul class="divide-y divide-gray-100" data-github-items-target="list">
      <% items.first(20).each do |item| %>
        <li class="px-4 py-2.5 hover:bg-gray-50 group"
            data-github-items-target="item"
            data-item-id="<%= item[:id] %>">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5">
              <% case item[:type] %>
              <% when :notification %>
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-600">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                  </svg>
                </span>
              <% when :issue %>
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-green-100 text-green-600">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                </span>
              <% when :pr %>
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full <%= item[:draft] ? 'bg-gray-100 text-gray-600' : 'bg-purple-100 text-purple-600' %>">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                </span>
              <% end %>
            </div>
            <a href="<%= item[:url] %>" target="_blank" rel="noopener noreferrer" class="flex-1 min-w-0">
              <p class="text-sm text-gray-900 truncate"><%= item[:title] %></p>
              <p class="text-xs text-gray-500">
                <%= item[:repo] %>
                <% if item[:number] %>
                  #<%= item[:number] %>
                <% end %>
                <% if item[:reason] %>
                  <span class="mx-1">&middot;</span>
                  <span class="<%= reason_class(item[:reason]) %>"><%= reason_label(item[:reason]) %></span>
                <% end %>
                <% if item[:draft] %>
                  <span class="mx-1">&middot;</span>
                  <span class="text-gray-400">draft</span>
                <% end %>
              </p>
            </a>
            <div class="flex-shrink-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button type="button"
                      data-action="click->github-items#snooze"
                      class="p-1 text-gray-400 hover:text-amber-600 hover:bg-amber-50 rounded"
                      title="Snooze tot morgen">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </button>
              <button type="button"
                      data-action="click->github-items#ignore"
                      class="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded"
                      title="Negeren">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
              </button>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
    <% if items.size > 20 %>
      <div class="px-4 py-2 text-center text-xs text-gray-500 border-t border-gray-100">
        en <%= items.size - 20 %> meer...
      </div>
    <% end %>
  <% end %>
</div>
