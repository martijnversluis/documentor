<div data-controller="expand-preview">
<div class="max-w-4xl mx-auto space-y-6 transition-all duration-200" data-expand-preview-target="container">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <div class="flex items-center space-x-2 text-sm text-gray-500 mb-1">
        <% if @document.folder %>
          <%= link_to @document.folder.dossier.name, @document.folder.dossier, class: "hover:text-gray-700" %>
          <span>/</span>
          <%= link_to @document.folder.name, @document.folder.dossier, class: "hover:text-gray-700" %>
          <span>/</span>
        <% elsif @document.dossier %>
          <%= link_to @document.dossier.name, @document.dossier, class: "hover:text-gray-700" %>
          <span>/</span>
        <% else %>
          <%= link_to "Inbox", inbox_path, class: "hover:text-gray-700" %>
          <span>/</span>
        <% end %>
      </div>
      <h1 class="text-2xl font-bold text-gray-900"><%= @document.name %></h1>
      <p class="text-sm text-gray-500 mt-1">
        <%= @document.display_date.strftime("%d-%m-%Y %H:%M") %>
        <% if @document.file.attached? %>
          &middot; <%= number_to_human_size(@document.file.byte_size) %>
          &middot; <%= @document.file.content_type %>
        <% end %>
      </p>
      <%= render "party_links/party_links", linkable: @document %>
      <% if @document.action_items.any? %>
        <div class="mt-3">
          <h4 class="text-sm font-medium text-gray-700 mb-1">Actiepunten</h4>
          <div class="flex flex-wrap gap-1">
            <% @document.action_items.each do |item| %>
              <span class="inline-flex items-center gap-1 px-2 py-1 bg-orange-50 text-orange-700 rounded text-xs">
                <%= link_to item.description.truncate(30), item.dossier, class: "hover:underline" %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if @document.remarks.present? %>
        <div class="mt-2 text-sm text-gray-700 bg-yellow-50 border border-yellow-100 rounded p-2 prose prose-sm max-w-none"><%= markdown(@document.remarks) %></div>
      <% end %>
      <% if @document.source_description.present? %>
        <div class="mt-2 text-xs text-gray-500 bg-gray-50 rounded p-2 prose prose-xs max-w-none"><%= markdown(@document.source_description) %></div>
      <% end %>
      <% if @document.expires_at.present? %>
        <div class="mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium <%= @document.expired? ? 'bg-red-100 text-red-800' : @document.expiring_soon? ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-700' %>">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <% if @document.expired? %>
            Verlopen op <%= @document.expires_at.strftime("%d-%m-%Y") %> (<%= @document.days_until_expiration.abs %> dagen geleden)
          <% elsif @document.expiring_soon? %>
            Verloopt op <%= @document.expires_at.strftime("%d-%m-%Y") %> (nog <%= @document.days_until_expiration %> dagen)
          <% else %>
            Verloopt op <%= @document.expires_at.strftime("%d-%m-%Y") %>
          <% end %>
        </div>
        <% if @document.expiration_description.present? %>
          <div class="mt-2 text-sm text-gray-600 prose prose-sm max-w-none"><%= markdown(@document.expiration_description) %></div>
        <% end %>
      <% end %>
    </div>
    <div class="flex items-center space-x-2">
      <% if @document.file.attached? %>
        <button type="button"
                data-controller="download"
                data-download-url-value="<%= download_document_path(@document) %>"
                data-download-filename-value="<%= @document.name %><%= File.extname(@document.file.filename.to_s) unless @document.name.include?('.') %>"
                data-action="click->download#download"
                class="inline-flex items-center px-3 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Downloaden
        </button>
      <% end %>
      <%= link_to edit_document_path(@document), class: "inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50" do %>
        Bewerken
      <% end %>
    </div>
  </div>

  <% if @document.file.attached? %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 relative">
      <button type="button"
              data-expand-preview-target="button"
              data-action="click->expand-preview#toggle"
              class="absolute top-2 right-2 p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded"
              title="Vergroot/verklein preview">
        <svg class="w-5 h-5 expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
        </svg>
        <svg class="w-5 h-5 collapse-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"></path>
        </svg>
      </button>
      <% if @document.file.content_type.start_with?("image/") %>
        <% if @document.file.content_type.in?(%w[image/heic image/heif]) %>
          <%# HEIC/HEIF images need to be converted for browser display %>
          <%= image_tag @document.file.variant(format: :jpeg), class: "max-w-full h-auto rounded" %>
        <% else %>
          <%= image_tag @document.file, class: "max-w-full h-auto rounded" %>
        <% end %>
      <% elsif @document.file.content_type == "application/pdf" %>
        <iframe src="<%= rails_blob_path(@document.file, disposition: "inline") %>" class="w-full h-[800px] rounded border"></iframe>
      <% elsif @document.file.content_type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document" %>
        <div data-controller="docx-viewer" data-docx-viewer-url-value="<%= rails_blob_path(@document.file) %>">
          <div data-docx-viewer-target="output" class="prose max-w-none">
            <p class="text-gray-500">Document laden...</p>
          </div>
        </div>
      <% elsif @document.file.content_type == "text/plain" %>
        <pre class="whitespace-pre-wrap text-sm text-gray-800 font-mono bg-gray-50 p-4 rounded overflow-x-auto"><%= @document.file.download.force_encoding("UTF-8") %></pre>
      <% elsif @document.file.content_type == "message/rfc822" || @document.file.filename.to_s.end_with?(".eml") %>
        <% eml = parse_eml(@document.file) %>
        <div class="space-y-4">
          <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm border-b border-gray-200 pb-4">
            <% if eml[:from].present? %>
              <span class="font-medium text-gray-500">Van:</span>
              <span class="text-gray-900"><%= eml[:from] %></span>
            <% end %>
            <% if eml[:to].present? %>
              <span class="font-medium text-gray-500">Aan:</span>
              <span class="text-gray-900"><%= eml[:to] %></span>
            <% end %>
            <% if eml[:cc].present? %>
              <span class="font-medium text-gray-500">CC:</span>
              <span class="text-gray-900"><%= eml[:cc] %></span>
            <% end %>
            <% if eml[:subject].present? %>
              <span class="font-medium text-gray-500">Onderwerp:</span>
              <span class="text-gray-900 font-medium"><%= eml[:subject] %></span>
            <% end %>
            <% if eml[:date].present? %>
              <span class="font-medium text-gray-500">Datum:</span>
              <span class="text-gray-900"><%= eml[:date].strftime("%d-%m-%Y %H:%M") %></span>
            <% end %>
          </div>
          <div class="prose max-w-none">
            <%= sanitize eml[:body], tags: %w[p br div span a b i u strong em ul ol li h1 h2 h3 h4 h5 h6 table tr td th thead tbody blockquote pre code img hr], attributes: %w[href src alt class style] %>
          </div>
        </div>
      <% else %>
        <div class="text-center py-12">
          <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="mt-4 text-gray-500">Preview niet beschikbaar voor dit bestandstype.</p>
          <p class="text-sm text-gray-400"><%= @document.file.content_type %></p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
</div>
